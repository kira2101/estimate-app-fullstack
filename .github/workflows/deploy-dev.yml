name: Deploy to Dev Environment

on:
  push:
    branches: [ dev ]
  workflow_dispatch:

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    
    steps:
    - name: üõéÔ∏è Checkout repository
      uses: actions/checkout@v4

    - name: üê≥ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: üîß Build Backend Image (Dev)
      run: |
        docker build -t estimate-app-backend:dev ./backend

    - name: üé® Build Frontend Image (Dev) 
      run: |
        docker build -t estimate-app-frontend:dev ./frontend \
          --build-arg VITE_API_BASE_URL=https://dev.app.iqbs.pro/api/v1

    - name: üíæ Save Docker Images
      run: |
        docker save estimate-app-backend:dev | gzip > backend-dev.tar.gz
        docker save estimate-app-frontend:dev | gzip > frontend-dev.tar.gz

    - name: üì¶ Deploy to Dev Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        script_timeout: 30m
        script: |
          set -e
          
          echo "üöÄ Starting dev deployment..."
          
          # –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
          cd /var/www/estimate-app
          
          # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ dev –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω—ã)
          docker stop estimate-backend-dev estimate-frontend-dev 2>/dev/null || true
          docker rm estimate-backend-dev estimate-frontend-dev 2>/dev/null || true
          
          # –°–æ–∑–¥–∞–Ω–∏–µ dev –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
          mkdir -p /var/www/estimate-app-dev
          cd /var/www/estimate-app-dev
          
          # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–¥–∞ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–æ dev –≤–µ—Ç–∫–∏)
          git clone https://github.com/kira2101/estimate-app-fullstack.git . 2>/dev/null || git pull origin dev
          git checkout dev
          git pull origin dev
          
          # –°–æ–∑–¥–∞–Ω–∏–µ .env –¥–ª—è dev –æ–∫—Ä—É–∂–µ–Ω–∏—è
          cat > .env << 'EOF'
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          ALLOWED_HOSTS=dev.app.iqbs.pro,localhost,127.0.0.1
          CORS_ALLOWED_ORIGINS=https://dev.app.iqbs.pro,http://dev.app.iqbs.pro
          CSRF_TRUSTED_ORIGINS=https://dev.app.iqbs.pro,http://dev.app.iqbs.pro
          SSL_ENABLED=True
          VITE_API_BASE_URL=https://dev.app.iqbs.pro/api/v1
          EOF
          
          echo "üì• Transferring dev images..."

    - name: üì§ Transfer Docker Images
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        source: "backend-dev.tar.gz,frontend-dev.tar.gz"
        target: "/var/www/estimate-app-dev/"

    - name: üê≥ Deploy Dev Containers
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        script_timeout: 15m
        script: |
          set -e
          
          cd /var/www/estimate-app-dev
          
          echo "üì¶ Loading dev images..."
          docker load < backend-dev.tar.gz
          docker load < frontend-dev.tar.gz
          
          # –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
          rm -f backend-dev.tar.gz frontend-dev.tar.gz
          
          # –°–æ–∑–¥–∞–Ω–∏–µ dev —Å–µ—Ç–∏ (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
          docker network create estimate_dev_network 2>/dev/null || true
          
          echo "üöÄ Starting dev containers..."
          
          # –ó–∞–ø—É—Å–∫ backend –Ω–∞ –ø–æ—Ä—Ç—É 8001
          docker run -d \
            --name estimate-backend-dev \
            --network estimate_dev_network \
            -p 8001:8000 \
            --env-file .env \
            --add-host=host.docker.internal:host-gateway \
            -v /var/www/estimate-app-dev/logs:/app/logs \
            estimate-app-backend:dev
          
          # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ backend
          sleep 10
          
          # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π (–∫ —Ç–æ–π –∂–µ –ë–î, —á—Ç–æ –∏ –ø—Ä–æ–¥–∞–∫—à–Ω)
          docker exec estimate-backend-dev python manage.py migrate
          
          # –ó–∞–ø—É—Å–∫ frontend –Ω–∞ –ø–æ—Ä—Ç—É 3001
          docker run -d \
            --name estimate-frontend-dev \
            --network estimate_dev_network \
            -p 3001:80 \
            estimate-app-frontend:dev
          
          echo "‚úÖ Dev deployment completed!"
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
          sleep 5
          echo "üìä Container status:"
          docker ps | grep "estimate.*dev"
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ health check
          echo "üîç Health check:"
          curl -f http://localhost:8001/api/v1/health/ || echo "‚ö†Ô∏è Backend health check failed"

    - name: üéâ Deployment Complete
      run: |
        echo "‚úÖ Dev deployment completed successfully!"
        echo "üåê Access dev environment at: https://dev.app.iqbs.pro"
        echo "üìä Backend API: https://dev.app.iqbs.pro/api/v1/"