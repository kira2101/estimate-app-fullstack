name: Deploy to Dev Environment

on:
  push:
    branches: [ dev ]
  workflow_dispatch:

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ›Žï¸ Checkout repository
      uses: actions/checkout@v4

    - name: ðŸ³ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ðŸ”§ Build Backend Image (Dev)
      run: |
        docker build -t estimate-app-backend:dev ./backend

    - name: ðŸŽ¨ Build Frontend Image (Dev) 
      run: |
        docker build -t estimate-app-frontend:dev ./frontend \
          --build-arg VITE_API_BASE_URL=https://dev.app.iqbs.pro/api/v1

    - name: ðŸ’¾ Save Docker Images
      run: |
        docker save estimate-app-backend:dev | gzip > backend-dev.tar.gz
        docker save estimate-app-frontend:dev | gzip > frontend-dev.tar.gz

    - name: ðŸ“¦ Deploy to Dev Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        script_timeout: 30m
        script: |
          set -e
          
          echo "ðŸš€ Starting dev deployment..."
          
          # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð² Ñ€Ð°Ð±Ð¾Ñ‡ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
          cd /var/www/estimate-app
          
          # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° dev ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² (ÐµÑÐ»Ð¸ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹)
          docker stop estimate-backend-dev estimate-frontend-dev 2>/dev/null || true
          docker rm estimate-backend-dev estimate-frontend-dev 2>/dev/null || true
          
          # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ dev Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
          mkdir -p /var/www/estimate-app-dev
          cd /var/www/estimate-app-dev
          
          # Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ ÐºÐ¾Ð´Ð° Ð¸Ð· Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ (Ð½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð´Ð¾ dev Ð²ÐµÑ‚ÐºÐ¸)
          git clone https://github.com/kira2101/estimate-app-fullstack.git . 2>/dev/null || git pull origin dev
          git checkout dev
          git pull origin dev
          
          # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ð´Ð»Ñ dev Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
          cat > .env << 'EOF'
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          ALLOWED_HOSTS=dev.app.iqbs.pro,localhost,127.0.0.1
          CORS_ALLOWED_ORIGINS=https://dev.app.iqbs.pro,http://dev.app.iqbs.pro
          CSRF_TRUSTED_ORIGINS=https://dev.app.iqbs.pro,http://dev.app.iqbs.pro
          SSL_ENABLED=True
          VITE_API_BASE_URL=https://dev.app.iqbs.pro/api/v1
          EOF
          
          echo "ðŸ“¥ Transferring dev images..."

    - name: ðŸ“¤ Transfer Docker Images
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        source: "backend-dev.tar.gz,frontend-dev.tar.gz"
        target: "/var/www/estimate-app-dev/"

    - name: ðŸ³ Deploy Dev Containers
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        script_timeout: 15m
        script: |
          set -e
          
          cd /var/www/estimate-app-dev
          
          echo "ðŸ“¦ Loading dev images..."
          docker load < backend-dev.tar.gz
          docker load < frontend-dev.tar.gz
          
          # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
          rm -f backend-dev.tar.gz frontend-dev.tar.gz
          
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½ÑƒÑŽ ÑÐµÑ‚ÑŒ estimate_network Ð´Ð»Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº PostgreSQL
          echo "ðŸš€ Starting dev containers..."
          
          # Ð—Ð°Ð¿ÑƒÑÐº backend Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 8001 Ð² Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÑÐµÑ‚Ð¸
          docker run -d \
            --name estimate-backend-dev \
            --network estimate_network \
            -p 8001:8000 \
            --env-file .env \
            -e DATABASE_URL=postgresql://estimate_user:secure_password_123@estimate-postgres:5432/estimate_app_dev_db \
            -v /var/www/estimate-app-dev/logs:/app/logs \
            estimate-app-backend:dev
          
          # ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° backend
          sleep 10
          
          # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ dev Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…, ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚
          docker exec estimate-postgres psql -U estimate_user -d postgres -c "SELECT 1 FROM pg_database WHERE datname = 'estimate_app_dev_db'" | grep -q 1 || \
          docker exec estimate-postgres psql -U estimate_user -d postgres -c "CREATE DATABASE estimate_app_dev_db;"
          
          # ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹ Ðº dev Ð‘Ð”
          docker exec estimate-backend-dev python manage.py migrate
          
          # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ dev Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
          docker exec estimate-backend-dev python manage.py seed_db
          
          # Ð—Ð°Ð¿ÑƒÑÐº frontend Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 3001 Ð² Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÑÐµÑ‚Ð¸
          docker run -d \
            --name estimate-frontend-dev \
            --network estimate_network \
            -p 3001:80 \
            estimate-app-frontend:dev
          
          echo "âœ… Dev deployment completed!"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
          sleep 5
          echo "ðŸ“Š Container status:"
          docker ps | grep "estimate.*dev"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° health check
          echo "ðŸ” Health check:"
          curl -f http://localhost:8001/api/v1/health/ || echo "âš ï¸ Backend health check failed"

    - name: ðŸŽ‰ Deployment Complete
      run: |
        echo "âœ… Dev deployment completed successfully!"
        echo "ðŸŒ Access dev environment at: https://dev.app.iqbs.pro"
        echo "ðŸ“Š Backend API: https://dev.app.iqbs.pro/api/v1/"