name: üöÄ –ë—ã—Å—Ç—Ä—ã–π –¥–µ–ø–ª–æ–π Dev –æ–∫—Ä—É–∂–µ–Ω–∏—è

on:
  push:
    branches: [ dev ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: '–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–ø–ª–æ–π –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–æ–∫'
        required: false
        default: false
        type: boolean

env:
  SERVER_HOST: 195.14.122.135
  DEV_PROJECT_PATH: /var/www/estimate-app-dev
  DEV_BACKEND_PORT: 8001
  DEV_FRONTEND_PORT: 3001

jobs:
  quick-deploy-dev:
    name: üì¶ –ë—ã—Å—Ç—Ä—ã–π –¥–µ–ø–ª–æ–π –≤ Dev
    runs-on: ubuntu-latest
    
    steps:
    - name: üîç Checkout –∫–æ–¥–∞
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –∫–ª—é—á–∞
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.DEV_SSH_PRIVATE_KEY }}

    - name: üåê –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤ known_hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: üìã –ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
      id: changes
      run: |
        echo "–ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –º–µ–∂–¥—É –∫–æ–º–º–∏—Ç–∞–º–∏..."
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || echo "")
        echo "changed_files<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π
        BACKEND_CHANGED=false
        FRONTEND_CHANGED=false
        MIGRATIONS_CHANGED=false
        
        if echo "$CHANGED_FILES" | grep -E '\.(py|txt)$'; then
          BACKEND_CHANGED=true
        fi
        
        if echo "$CHANGED_FILES" | grep -E '\.(js|jsx|ts|tsx|json|css|html)$'; then
          FRONTEND_CHANGED=true
        fi
        
        if echo "$CHANGED_FILES" | grep -E 'migrations/'; then
          MIGRATIONS_CHANGED=true
        fi
        
        echo "backend_changed=$BACKEND_CHANGED" >> $GITHUB_OUTPUT
        echo "frontend_changed=$FRONTEND_CHANGED" >> $GITHUB_OUTPUT
        echo "migrations_changed=$MIGRATIONS_CHANGED" >> $GITHUB_OUTPUT
        
        echo "üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:"
        echo "Backend: $BACKEND_CHANGED"
        echo "Frontend: $FRONTEND_CHANGED" 
        echo "Migrations: $MIGRATIONS_CHANGED"

    - name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ dev —Å–µ—Ä–≤–µ—Ä
      run: |
        ssh -o StrictHostKeyChecking=no ubuntu@${{ env.SERVER_HOST }} << 'ENDSSH'
          set -e
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
          cd ${{ env.DEV_PROJECT_PATH }}
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ dev –≤–µ—Ç–∫–∏
          echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ –≤–µ—Ç–∫–∏ dev..."
          git fetch origin dev
          git reset --hard origin/dev
          
          # –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
          chmod +x deploy/quick-deploy-dev.sh
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Docker –¥–µ–ø–ª–æ–π —Å–∫—Ä–∏–ø—Ç
          echo "üöÄ –ó–∞–ø—É—Å–∫ Docker –¥–µ–ø–ª–æ—è..."
          ./deploy/quick-deploy-dev.sh
        ENDSSH

    - name: üéØ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–ø–ª–æ—è
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ dev –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ API health endpoint
        if curl -f -s https://dev.app.iqbs.pro/api/v1/health/ | grep -q "healthy"; then
          echo "‚úÖ Dev API —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
        else
          echo "‚ùå Dev API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          exit 1
        fi
        
        echo "üéâ –î–µ–ø–ª–æ–π dev –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
        echo ""
        echo "üìç –î–µ–ø–ª–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
        echo "   üåê URL: https://dev.app.iqbs.pro"
        echo "   üîó API: https://dev.app.iqbs.pro/api/v1/"
        echo "   üìÖ –í—Ä–µ–º—è: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "   üöÄ –ö–æ–º–º–∏—Ç: ${{ github.sha }}"
        echo "   üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}"

    - name: üìä –û—Ç—á–µ—Ç –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
      if: always()
      run: |
        echo "üìã –û—Ç—á–µ—Ç –æ –¥–µ–ø–ª–æ–µ:"
        echo "–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:"
        echo "${{ steps.changes.outputs.changed_files }}"
        echo ""
        echo "–¢–∏–ø—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π:"
        echo "  Backend: ${{ steps.changes.outputs.backend_changed }}"
        echo "  Frontend: ${{ steps.changes.outputs.frontend_changed }}"
        echo "  Migrations: ${{ steps.changes.outputs.migrations_changed }}"