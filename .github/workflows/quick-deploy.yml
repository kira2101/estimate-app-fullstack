name: ‚ö° Quick Deploy (Code Changes Only)

on:
  # push:
  #   branches:
  #     - dev  # –û–¢–ö–õ–Æ–ß–ï–ù–û - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è deploy-dev.yml
  workflow_dispatch:
    inputs:
      deploy_type:
        description: '–¢–∏–ø –¥–µ–ø–ª–æ—è'
        required: true
        default: 'code-only'
        type: choice
        options:
          - code-only
          - backend-only
          - migrations-only

env:
  SERVER_HOST: 195.14.122.135
  SERVER_USER: root
  PROJECT_PATH: /var/www/estimate-app

jobs:
  quick-deploy:
    name: ‚ö° Quick Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # –ù—É–∂–Ω–æ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

      - name: üîë Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.PRODUCTION_SSH_KEY }}

      - name: üìã Analyze changes
        id: changes
        run: |
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∏–∑–º–µ–Ω–µ–Ω–∏–π
          if git diff --name-only HEAD~1 HEAD | grep -E '\.py$'; then
            echo "backend_changed=true" >> $GITHUB_OUTPUT
          fi
          
          if git diff --name-only HEAD~1 HEAD | grep -E '\.(js|jsx|ts|tsx)$'; then
            echo "frontend_changed=true" >> $GITHUB_OUTPUT
          fi
          
          if git diff --name-only HEAD~1 HEAD | grep migrations; then
            echo "migrations_changed=true" >> $GITHUB_OUTPUT
          fi

      - name: ‚ö° Deploy code changes
        run: |
          # –ö–æ–ø–∏—Ä—É–µ–º —Å–∫—Ä–∏–ø—Ç –±—ã—Å—Ç—Ä–æ–≥–æ –¥–µ–ø–ª–æ—è
          scp deploy/quick-deploy.sh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:${{ env.PROJECT_PATH }}/
          
          # –í—ã–ø–æ–ª–Ω—è–µ–º –±—ã—Å—Ç—Ä—ã–π –¥–µ–ø–ª–æ–π
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "cd ${{ env.PROJECT_PATH }} && bash quick-deploy.sh ${{ github.sha }}"

      - name: üèóÔ∏è Rebuild frontend (if needed)
        if: steps.changes.outputs.frontend_changed == 'true'
        run: |
          echo "‚ö†Ô∏è Frontend –∏–∑–º–µ–Ω–∏–ª—Å—è - —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞"
          echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–æ–ª–Ω—ã–π –¥–µ–ø–ª–æ–π –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è frontend"

      - name: ‚úÖ Quick deployment success
        run: |
          echo "‚ö° –ë—ã—Å—Ç—Ä—ã–π –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
          echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞: http://app.iqbs.pro"
          if [ "${{ steps.changes.outputs.frontend_changed }}" == "true" ]; then
            echo "‚ö†Ô∏è –î–ª—è frontend –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ª–Ω—ã–π –¥–µ–ø–ª–æ–π"
          fi