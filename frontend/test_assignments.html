<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç ProjectAssignmentsPage</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-result {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        .info { border-left: 4px solid #2196F3; }
        pre {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 3px;
            overflow: auto;
        }
        .btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #1976D2;
        }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ä–∞–±–æ–≤ –≤ ProjectAssignmentsPage</h1>
    
    <div class="test-result info">
        <h3>üìã –û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞</h3>
        <p>–ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ—Ä–∞–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ –¥–∏–∞–ª–æ–≥–µ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π.</p>
        <p><strong>Dev environment:</strong> <a href="https://dev.app.iqbs.pro" target="_blank">https://dev.app.iqbs.pro</a></p>
    </div>

    <button class="btn" onclick="runTest()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
    <button class="btn" onclick="clearResults()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>

    <div id="results"></div>

    <script>
        const API_BASE_URL = 'https://dev.app.iqbs.pro/api/v1';
        const LOGIN_DATA = {
            email: 'manager@example.com',
            password: 'password123'
        };

        function addResult(type, title, content) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<h3>${title}</h3><div>${content}</div>`;
            results.appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function runTest() {
            clearResults();
            
            try {
                // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
                addResult('info', 'üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', '–í—ã–ø–æ–ª–Ω—è–µ–º –≤—Ö–æ–¥...');
                
                const loginResponse = await fetch(`${API_BASE_URL}/auth/login/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(LOGIN_DATA)
                });

                if (!loginResponse.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${loginResponse.status}`);
                }

                const loginData = await loginResponse.json();
                const token = loginData.token;
                const user = loginData.user;

                addResult('success', '‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞', 
                    `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user.full_name} (${user.role})`);

                const headers = {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                };

                // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                addResult('info', 'üë• –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', '–ó–∞–ø—Ä–æ—Å –∫ API...');
                
                const usersResponse = await fetch(`${API_BASE_URL}/users/`, { headers });
                if (!usersResponse.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${usersResponse.status}`);
                }

                const usersData = await usersResponse.json();
                const users = usersData.results || usersData;
                const foremen = users.filter(user => user.role === '–ø—Ä–æ—Ä–∞–±');

                addResult('success', '‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 
                    `–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${users.length}<br>–ü—Ä–æ—Ä–∞–±–æ–≤: ${foremen.length}<br><br>
                    <strong>–°–ø–∏—Å–æ–∫ –ø—Ä–æ—Ä–∞–±–æ–≤:</strong><br>
                    ${foremen.map(f => `‚Ä¢ ${f.full_name} (ID: ${f.user_id})`).join('<br>')}`);

                // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤
                addResult('info', 'üèóÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤', '–ó–∞–ø—Ä–æ—Å –∫ API...');
                
                const projectsResponse = await fetch(`${API_BASE_URL}/projects/`, { headers });
                if (!projectsResponse.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤: ${projectsResponse.status}`);
                }

                const projectsData = await projectsResponse.json();
                const projects = projectsData.results || projectsData;

                addResult('success', '‚úÖ –ü—Ä–æ–µ–∫—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 
                    `–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–µ–∫—Ç–æ–≤: ${projects.length}<br><br>
                    <strong>–°–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤:</strong><br>
                    ${projects.map(p => `‚Ä¢ ${p.project_name} (ID: ${p.project_id})`).join('<br>')}`);

                // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π
                addResult('info', 'üìã –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π', '–ó–∞–ø—Ä–æ—Å –∫ API...');
                
                const assignmentsResponse = await fetch(`${API_BASE_URL}/project-assignments/`, { headers });
                if (!assignmentsResponse.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π: ${assignmentsResponse.status}`);
                }

                const assignmentsData = await assignmentsResponse.json();
                const assignments = assignmentsData.results || assignmentsData;

                addResult('success', '‚úÖ –ù–∞–∑–Ω–∞—á–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 
                    `–ù–∞–π–¥–µ–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π: ${assignments.length}<br><br>
                    <strong>–¢–µ–∫—É—â–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:</strong><br>
                    ${assignments.map(a => `‚Ä¢ ${a.project_name} ‚Üí ${a.user_full_name}`).join('<br>')}`);

                // –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                addResult('success', 'üéâ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 
                    `<strong>–ò—Ç–æ–≥–æ:</strong><br>
                    ‚Ä¢ –ü—Ä–æ–µ–∫—Ç–æ–≤: ${projects.length}<br>
                    ‚Ä¢ –ü—Ä–æ—Ä–∞–±–æ–≤: ${foremen.length}<br>
                    ‚Ä¢ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–π: ${assignments.length}<br><br>
                    
                    <strong>–°—Ç–∞—Ç—É—Å:</strong> –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. 
                    –ü—Ä–æ—Ä–∞–±—ã –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π.`);

            } catch (error) {
                addResult('error', '‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞', 
                    `<strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong> ${error.message}<br>
                    <pre>${error.stack || 'Stack trace –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}</pre>`);
            }
        }

        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            addResult('info', '‚è±Ô∏è –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫', '–¢–µ—Å—Ç –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã...');
            setTimeout(runTest, 2000);
        }, 100);
    </script>
</body>
</html>