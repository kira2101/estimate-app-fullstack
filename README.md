# Сервис Строительных Смет (Construction Estimate Service)

## Обзор Проекта

"Сервис Строительных Смет" - это полнофункциональное веб-приложение, предназначенное для управления строительными сметами. Оно разработано с учетом потребностей двух основных ролей: **Менеджеров** и **Прорабов**, каждая из которых имеет свои уникальные права доступа и функциональные возможности. Приложение обеспечивает строгое разделение цен (себестоимость и цена для клиента) и контролируемый процесс изменения себестоимости через запросы, одобряемые менеджером.

### Ключевые Особенности

*   **Двухуровневое ценообразование:** Разделение на себестоимость (для внутреннего учета) и цену для клиента (для продаж).
*   **Управление ролями:** Различные уровни доступа и функционала для Менеджеров и Прорабов.
*   **Контроль изменений себестоимости:** Прорабы могут запрашивать изменения себестоимости, которые должны быть одобрены Менеджерами.
*   **Управление проектами и сметами:** Полный цикл создания, редактирования и отслеживания строительных смет.
*   **Справочники:** Управление категориями работ, видами работ и их ценами.
*   **Аутентификация:** Безопасный вход в систему с использованием JWT-токенов.

### Используемые Технологии

**Бэкенд:**
*   **Фреймворк:** Django 5
*   **API:** Django REST Framework
*   **База данных:** SQLite (для разработки, легко переключается на PostgreSQL)
*   **Аутентификация:** Кастомная токен-аутентификация
*   **CORS:** `django-cors-headers`

**Фронтенд:**
*   **Фреймворк:** React 18
*   **Сборщик/Dev-сервер:** Vite
*   **Библиотека UI:** Material-UI 5
*   **Стили:** Bootstrap 5 (для дополнительных стилей)
*   **Линтинг:** ESLint

## Архитектура Проекта

Приложение построено по классической клиент-серверной архитектуре:

*   **Фронтенд** представляет собой одностраничное приложение (SPA), разработанное на React, которое взаимодействует с бэкендом через RESTful API.
*   **Бэкенд** предоставляет все необходимые API-эндпоинты для управления данными, аутентификации и бизнес-логики.

### Структура Каталогов

```
.
├── backend/                  # Django бэкенд
│   ├── api/                  # Основное Django приложение API
│   │   ├── migrations/       # Миграции базы данных
│   │   ├── __pycache__/
│   │   ├── admin.py          # Настройки админ-панели Django
│   │   ├── authentication.py # Кастомная аутентификация
│   │   ├── apps.py
│   │   ├── models.py         # Модели базы данных
│   │   ├── permissions.py    # Кастомные права доступа
│   │   ├── serializers.py    # Сериализаторы Django REST Framework
│   │   ├── tests.py
│   │   ├── urls.py           # URL-маршруты API
│   │   └── views.py          # Представления API
│   ├── core/                 # Основной проект Django
│   │   ├── __pycache__/
│   │   ├── asgi.py
│   │   ├── settings.py       # Настройки Django
│   │   ├── urls.py           # Главные URL-маршруты проекта
│   │   ├── wsgi.py
│   ├── db.sqlite3            # Файл базы данных SQLite (для разработки)
│   ├── manage.py             # Утилита управления Django
│   └── .venv/                # Виртуальное окружение Python
├── frontend/                 # React фронтенд
│   ├── public/               # Статические файлы
│   ├── src/                  # Исходный код фронтенда
│   │   ├── api/              # API-клиент для взаимодействия с бэкендом
│   │   │   └── client.js
│   │   ├── components/       # Переиспользуемые компоненты UI
│   │   ├── pages/            # Страницы приложения
│   │   ├── App.jsx           # Главный компонент приложения
│   │   └── main.jsx          # Точка входа в приложение
│   ├── node_modules/         # Зависимости Node.js
│   ├── package.json          # Описание проекта и зависимости Node.js
│   ├── package-lock.json
│   ├── vite.config.js        # Конфигурация Vite
│   └── .gitignore
├── .git/
├── .gitignore
├── BACKEND_API_GUIDE.md      # Руководство по API бэкенда
├── BD.MD                     # Описание схемы базы данных
├── DEVELOPMENT_PLAN.md       # План разработки (исторический)
├── FRONTEND_DEVELOPMENT_GUIDE.md # Руководство по разработке фронтенда
├── GEMINI.md                 # Контекст для Gemini CLI
├── main.py                   # Возможно, скрипт для запуска или утилита
└── .venv/                    # Общее виртуальное окружение Python
```

## Настройка и Запуск Проекта

### Предварительные Требования

*   Python 3.8+
*   Node.js 18+
*   npm (обычно поставляется с Node.js)
*   Git

### 1. Клонирование Репозитория

```bash
git clone https://github.com/kira2101/estimate-app-fullstack.git
cd estimate-app-fullstack
```

### 2. Настройка Бэкенда

```bash
cd backend

# Создание и активация виртуального окружения
python -m venv .venv
source .venv/bin/activate

# Установка зависимостей
# (Предполагается, что requirements.txt будет создан или уже существует)
# Если requirements.txt отсутствует, его нужно создать вручную,
# добавив основные зависимости: django, djangorestframework, django-cors-headers
pip install django djangorestframework django-cors-headers djangorestframework-simplejwt

# Применение миграций базы данных
python manage.py migrate

# Запуск сервера разработки
# Сервер будет доступен по адресу http://127.0.0.1:8000/
python manage.py runserver
```

### 3. Настройка Фронтенда

```bash
cd frontend

# Установка зависимостей
npm install

# Запуск сервера разработки
# Фронтенд будет доступен по адресу http://localhost:5173/
npm run dev
```

## Анализ Функционала (для Разработчиков)

### 1. Аутентификация и Авторизация

*   **Механизм:** Используется кастомная токен-аутентификация на бэкенде (`api/authentication.py`) с JWT-токенами.
*   **Эндпоинт:** `POST /api/v1/auth/login/` для получения токена.
*   **Роли:** Система поддерживает роли (`менеджер`, `прораб`), которые определяют права доступа к различным ресурсам API (`api/permissions.py`).
*   **Фронтенд:** `LoginPage.jsx` обрабатывает вход, `App.jsx` управляет состоянием пользователя и токеном в `localStorage`.

### 2. Управление Проектами (Объектами)

*   **Модель:** `Project` (`api/models.py`).
*   **API:** `ProjectViewSet` (`api/views.py`) предоставляет CRUD-операции.
    *   Менеджеры имеют полный доступ.
    *   Прорабы видят только проекты, к которым они привязаны (`ProjectAssignment`).
*   **Фронтенд:** `ProjectsPage.jsx` - страница управления объектами. `App.jsx` и `EstimatesList.jsx` используют список объектов для фильтрации и отображения.

### 3. Управление Сметами (Estimates)

*   **Модель:** `Estimate` (`api/models.py`).
*   **API:** `EstimateViewSet` (`api/views.py`) предоставляет CRUD-операции.
    *   `get_serializer_class` динамически выбирает сериализатор: `EstimateListSerializer` для списка и `EstimateDetailSerializer` для детальных операций.
    *   `perform_create` автоматически назначает создателя сметы.
*   **Сериализаторы:**
    *   `EstimateListSerializer`: Используется для получения списка смет, предоставляет плоскую структуру данных с именами связанных объектов (проект, создатель, статус, прораб).
    *   `EstimateDetailSerializer`: Используется для создания, обновления и получения детальной информации о смете. Включает вложенные сериализаторы для `project`, `creator`, `status`, `foreman` для чтения, и `PrimaryKeyRelatedField` для записи (ожидает ID).
*   **Фронтенд:**
    *   `EstimatesList.jsx`: Отображает список смет, фильтрует по объектам и ролям.
    *   `EstimateEditor.jsx`: Позволяет создавать и редактировать сметы, добавлять работы, выбирать статус и прораба.
    *   `App.jsx`: Управляет состоянием смет, вызывает API для сохранения и получения данных.

### 4. Управление Работами и Категориями

*   **Модели:** `WorkCategory`, `WorkType`, `WorkPrice` (`api/models.py`).
*   **API:** `WorkCategoryViewSet` и `WorkTypeViewSet` (`api/views.py`) для управления справочниками.
*   **Фронтенд:** `WorkCategoryPage.jsx` и `WorksPage.jsx` (страницы управления), `EstimateEditor.jsx` использует эти данные для добавления работ в смету.

### 5. Запросы на Изменение Цены (Price Change Requests)

*   **Модель:** `PriceChangeRequest` (`api/models.py`).
*   **Функционал:** Прорабы могут создавать запросы на изменение себестоимости для отдельных позиций сметы. Менеджеры могут одобрять или отклонять эти запросы.
*   **API:** Эндпоинты для создания, получения списка и обновления статуса запросов. (На данный момент не полностью реализованы в API и фронтенде).

## Разработка и Вклад

### Структура Кода

*   **Бэкенд:** Следует стандартной структуре Django. Логика API сосредоточена в приложении `api`.
*   **Фронтенд:** Следует компонентному подходу React. Состояние приложения управляется в `App.jsx` и передается вниз по дереву компонентов.

### Стиль Кодирования

*   **Python:** Используется `black` для форматирования, `flake8` для линтинга.
*   **JavaScript/React:** Используется `ESLint` для линтинга.

### Тестирование (TODO)

*   На данный момент автоматизированные тесты не реализованы. Рекомендуется использовать `pytest` для бэкенда и `Jest`/`React Testing Library` для фронтенда.

### Развертывание

*   **Разработка:**
    *   Бэкенд: `python manage.py runserver` (по умолчанию `http://127.0.0.1:8000/`)
    *   Фронтенд: `npm run dev` (по умолчанию `http://localhost:5173/`)
*   **Продакшен:** Требуется настройка веб-сервера (например, Nginx, Gunicorn) для Django и сборка фронтенда (`npm run build`).

## Известные Проблемы и Будущие Улучшения

### Известные Проблемы

*   **CORS:** Несмотря на настройки `django-cors-headers`, могут возникать проблемы с CORS в зависимости от среды запуска. Это требует дальнейшего расследования на уровне окружения (брандмауэры, прокси, конфигурация IDE).
*   **Неполная реализация функционала:** Некоторые части функционала (например, запросы на изменение цены, управление пользователями/статусами на фронтенде) не полностью интегрированы или реализованы.
*   **Отсутствие тестов:** Проект не имеет автоматизированных тестов, что затрудняет рефакторинг и добавление новых функций.
*   **Оптимизация производительности:** Для больших объемов данных может потребоваться оптимизация рендеринга на фронтенде (виртуализация списков, мемоизация).

### Будущие Улучшения

*   Полная интеграция функционала запросов на изменение цены.
*   Реализация страниц управления пользователями и статусами на фронтенде.
*   Добавление аутентификации и авторизации на уровне маршрутов фронтенда.
*   Более сложные форматы экспорта смет (PDF, Excel).
*   Система уведомлений.
*   Офлайн-режим с синхронизацией.
*   Внедрение глобального управления состоянием (React Context, Zustand, Redux).
*   Добавление валидации форм на фронтенде (Formik, React Hook Form).
*   Написание автоматизированных тестов для бэкенда и фронтенда.

---

Этот `README.md` предоставляет исчерпывающую информацию о проекте. Я уверен, что он будет очень полезен для других разработчиков.
